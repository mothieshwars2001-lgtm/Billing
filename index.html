<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paws & Claws Pet Clinic ‚Äî Management System</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --cream: #FAF7F2;
    --warm-white: #FFFDF9;
    --forest: #2D4A3E;
    --forest-light: #3D6455;
    --gold: #C4952A;
    --gold-light: #E8B84B;
    --rust: #B85C38;
    --sage: #7B9E87;
    --sage-light: #A8C5B0;
    --charcoal: #2C2C2C;
    --mid-gray: #7A7A7A;
    --light-gray: #E8E3DC;
    --border: #D8D0C4;
    --paid: #2D7A4F;
    --draft: #B85C38;
    --outstanding: #7B4FA0;
    --shadow: 0 4px 24px rgba(45,74,62,0.10);
    --shadow-lg: 0 12px 48px rgba(45,74,62,0.15);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--charcoal);
    min-height: 100vh;
  }

  /* SIDEBAR */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 240px;
    background: var(--forest);
    display: flex;
    flex-direction: column;
    z-index: 100;
    box-shadow: 4px 0 20px rgba(0,0,0,0.15);
  }

  .sidebar-logo {
    padding: 28px 24px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .sidebar-logo h1 {
    font-family: 'Playfair Display', serif;
    color: var(--gold-light);
    font-size: 18px;
    line-height: 1.2;
  }

  .sidebar-logo span {
    display: block;
    color: var(--sage-light);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 4px;
  }

  .nav-section {
    padding: 16px 0;
    flex: 1;
  }

  .nav-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.35);
    padding: 8px 24px 4px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 11px 24px;
    cursor: pointer;
    color: rgba(255,255,255,0.65);
    font-size: 14px;
    font-weight: 400;
    transition: all 0.2s;
    border-left: 3px solid transparent;
  }

  .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }

  .nav-item.active {
    color: var(--gold-light);
    background: rgba(196,149,42,0.12);
    border-left-color: var(--gold-light);
    font-weight: 500;
  }

  .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }

  .sidebar-footer {
    padding: 16px 24px;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 11px;
    color: rgba(255,255,255,0.3);
  }

  /* MAIN */
  .main {
    margin-left: 240px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .topbar {
    background: var(--warm-white);
    border-bottom: 1px solid var(--border);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .topbar h2 {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    color: var(--forest);
  }

  .topbar-actions { display: flex; gap: 10px; align-items: center; }

  .btn {
    padding: 9px 18px;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--forest);
    color: white;
  }
  .btn-primary:hover { background: var(--forest-light); }

  .btn-gold {
    background: var(--gold);
    color: white;
  }
  .btn-gold:hover { background: var(--gold-light); }

  .btn-outline {
    background: transparent;
    border: 1.5px solid var(--border);
    color: var(--charcoal);
  }
  .btn-outline:hover { border-color: var(--forest); color: var(--forest); }

  .btn-sm { padding: 6px 12px; font-size: 12px; }

  .content { padding: 28px 32px; flex: 1; }

  /* PAGES */
  .page { display: none; }
  .page.active { display: block; }

  /* DASHBOARD STATS */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }

  .stat-card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 22px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }

  .stat-card.green::before { background: var(--paid); }
  .stat-card.orange::before { background: var(--draft); }
  .stat-card.purple::before { background: var(--outstanding); }
  .stat-card.gold::before { background: var(--gold); }

  .stat-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--mid-gray);
    margin-bottom: 8px;
  }

  .stat-value {
    font-family: 'DM Mono', monospace;
    font-size: 26px;
    font-weight: 500;
    color: var(--charcoal);
  }

  .stat-sub { font-size: 12px; color: var(--mid-gray); margin-top: 4px; }

  /* FILTERS */
  .filter-bar {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .filter-bar label {
    font-size: 12px;
    color: var(--mid-gray);
    font-weight: 500;
  }

  select, input[type=text], input[type=date], input[type=number], input[type=tel], textarea {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    padding: 8px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: white;
    color: var(--charcoal);
    outline: none;
    transition: border-color 0.2s;
  }

  select:focus, input:focus, textarea:focus {
    border-color: var(--forest);
  }

  textarea { resize: vertical; width: 100%; min-height: 80px; }

  .search-input {
    flex: 1;
    min-width: 200px;
  }

  /* TABLE */
  .table-wrap {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead tr {
    background: var(--forest);
    color: white;
  }

  thead th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 500;
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    white-space: nowrap;
  }

  thead th:hover { background: var(--forest-light); }

  tbody tr {
    border-bottom: 1px solid var(--light-gray);
    transition: background 0.15s;
  }

  tbody tr:hover { background: rgba(45,74,62,0.04); }

  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 11px 16px;
    vertical-align: middle;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .badge-paid { background: rgba(45,122,79,0.12); color: var(--paid); }
  .badge-draft { background: rgba(184,92,56,0.12); color: var(--draft); }
  .badge-outstanding { background: rgba(123,79,160,0.12); color: var(--outstanding); }

  .pay-method {
    font-size: 11px;
    background: var(--light-gray);
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 500;
  }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(30,30,30,0.55);
    z-index: 500;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--warm-white);
    border-radius: 16px;
    width: 100%;
    max-width: 780px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
  }

  .modal-header {
    padding: 24px 28px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    background: var(--warm-white);
    z-index: 10;
  }

  .modal-header h3 {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    color: var(--forest);
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    color: var(--mid-gray);
    line-height: 1;
    padding: 4px;
  }

  .modal-body { padding: 24px 28px; }

  .modal-footer {
    padding: 16px 28px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  /* TABS */
  .tabs {
    display: flex;
    gap: 2px;
    background: var(--light-gray);
    border-radius: 10px;
    padding: 4px;
    margin-bottom: 24px;
  }

  .tab {
    flex: 1;
    padding: 9px 16px;
    text-align: center;
    cursor: pointer;
    border-radius: 7px;
    font-size: 13px;
    font-weight: 500;
    color: var(--mid-gray);
    transition: all 0.2s;
  }

  .tab.active {
    background: white;
    color: var(--forest);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* FORM GRID */
  .form-section {
    margin-bottom: 24px;
  }

  .form-section-title {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--forest);
    margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 1.5px solid var(--sage-light);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .form-grid.cols3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-grid.cols1 { grid-template-columns: 1fr; }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .form-group.span2 { grid-column: span 2; }
  .form-group.span3 { grid-column: span 3; }

  .form-group label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    color: var(--mid-gray);
    text-transform: uppercase;
  }

  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
  }

  /* BILLING TABLE IN MODAL */
  .billing-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 14px;
    font-size: 13px;
  }

  .billing-table th {
    background: var(--forest);
    color: white;
    padding: 8px 12px;
    text-align: left;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .billing-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--light-gray);
    vertical-align: middle;
  }

  .billing-table input { padding: 5px 8px; font-size: 12px; }
  .billing-table input[type=number] { width: 90px; }
  .billing-table select { padding: 5px 8px; font-size: 12px; }

  .billing-total {
    text-align: right;
    padding: 12px 0;
    border-top: 2px solid var(--forest);
    margin-top: 4px;
  }

  .billing-total .total-line {
    display: flex;
    justify-content: flex-end;
    gap: 20px;
    padding: 3px 0;
    font-size: 13px;
  }

  .billing-total .total-line.grand {
    font-size: 16px;
    font-weight: 700;
    color: var(--forest);
    margin-top: 4px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }

  .billing-total .total-line span:first-child { color: var(--mid-gray); }

  .remove-row {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--rust);
    font-size: 16px;
    padding: 2px 6px;
  }

  /* INVOICE PREVIEW */
  .invoice-preview {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    font-size: 13px;
  }

  .inv-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 18px;
    border-bottom: 2px solid var(--forest);
  }

  .inv-clinic h2 {
    font-family: 'Playfair Display', serif;
    color: var(--forest);
    font-size: 20px;
  }

  .inv-clinic p { color: var(--mid-gray); font-size: 12px; margin-top: 4px; }

  .inv-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .inv-section-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--mid-gray);
    margin-bottom: 6px;
  }

  .inv-section-value { font-weight: 600; font-size: 14px; color: var(--charcoal); }
  .inv-section-sub { font-size: 12px; color: var(--mid-gray); margin-top: 2px; }

  /* SOAP notes */
  .soap-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .soap-block {
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
  }

  .soap-block label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--forest);
    margin-bottom: 8px;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--mid-gray);
  }

  .empty-state svg { margin-bottom: 16px; opacity: 0.3; }
  .empty-state h3 { font-size: 16px; margin-bottom: 8px; color: var(--charcoal); }
  .empty-state p { font-size: 13px; }

  /* NOTIFICATION */
  .notification {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--forest);
    color: white;
    padding: 14px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    max-width: 340px;
  }

  .notification.show { transform: translateY(0); opacity: 1; }

  /* PAGINATION */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    border-top: 1px solid var(--border);
    font-size: 12px;
    color: var(--mid-gray);
  }

  .pagination-btns { display: flex; gap: 6px; }

  .page-btn {
    padding: 5px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 12px;
    color: var(--charcoal);
    transition: all 0.15s;
  }

  .page-btn:hover { background: var(--forest); color: white; border-color: var(--forest); }
  .page-btn.active { background: var(--forest); color: white; border-color: var(--forest); }

  /* Action link */
  .action-link {
    color: var(--forest);
    text-decoration: none;
    font-weight: 500;
    font-size: 12px;
    cursor: pointer;
    margin-right: 10px;
  }
  .action-link:hover { color: var(--gold); text-decoration: underline; }

  .action-link.danger { color: var(--rust); }
  .action-link.danger:hover { color: darkred; }

  .type-badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
  }
  .type-feline { background: rgba(123,79,160,0.1); color: var(--outstanding); }
  .type-canine { background: rgba(45,74,62,0.1); color: var(--forest); }
  .type-other { background: rgba(196,149,42,0.1); color: var(--gold); }

  /* Selected row */
  tbody tr.selected { background: rgba(45,74,62,0.07) !important; }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-header h3 {
    font-family: 'Playfair Display', serif;
    font-size: 17px;
    color: var(--forest);
  }

  /* Download report area */
  .export-bar {
    background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
    border-radius: 12px;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    color: white;
  }

  .export-bar h3 { font-family: 'Playfair Display', serif; font-size: 16px; margin-bottom: 4px; }
  .export-bar p { font-size: 12px; opacity: 0.75; }

  .export-controls { display: flex; gap: 10px; align-items: center; }
  .export-controls select { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.25); color: white; }
  .export-controls select option { background: var(--forest); }
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <h1>Paws & Claws</h1>
    <span>Pet Clinic ¬∑ Chennai</span>
  </div>
  <nav class="nav-section">
    <div class="nav-label">Main</div>
    <div class="nav-item active" onclick="showPage('dashboard')">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </div>
    <div class="nav-item" onclick="showPage('reception')">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Reception
    </div>
    <div class="nav-item" onclick="showPage('checkin')">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Check-in / SOAP
    </div>
    <div class="nav-item" onclick="showPage('billing')">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
      Billing
    </div>
    <div class="nav-label" style="margin-top:8px;">Reports</div>
    <div class="nav-item" onclick="showPage('invoices')">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      Invoice History
    </div>
  </nav>
  <div class="sidebar-footer">v1.0 ¬∑ Paws & Claws PMS</div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <h2 id="pageTitle">Dashboard</h2>
    <div class="topbar-actions">
      <span id="today-date" style="font-size:13px; color:var(--mid-gray);"></span>
      <button class="btn btn-primary" onclick="openNewPatientModal()">+ New Patient</button>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card gold">
          <div class="stat-label">Total Invoices</div>
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-sub" id="stat-revenue">Gross: ‚Çπ 0</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">Paid</div>
          <div class="stat-value" id="stat-paid">0</div>
          <div class="stat-sub" id="stat-paid-amt">‚Çπ 0</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-label">Draft / Unpaid</div>
          <div class="stat-value" id="stat-draft">0</div>
          <div class="stat-sub" id="stat-draft-amt">‚Çπ 0</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">Outstanding</div>
          <div class="stat-value" id="stat-outstanding">0</div>
          <div class="stat-sub" id="stat-outstanding-amt">‚Çπ 0</div>
        </div>
      </div>
      <div class="stats-grid" style="margin-bottom:28px;">
        <div class="stat-card green">
          <div class="stat-label">Registered Patients</div>
          <div class="stat-value" id="stat-patients">0</div>
          <div class="stat-sub">All species</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-label">Pet Owners</div>
          <div class="stat-value" id="stat-owners">0</div>
          <div class="stat-sub">Registered parents</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-label">Open Check-ins</div>
          <div class="stat-value" id="stat-checkins">0</div>
          <div class="stat-sub">Pending</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">Vaccinations</div>
          <div class="stat-value" id="stat-vaccinations">0</div>
          <div class="stat-sub">Records on file</div>
        </div>
      </div>

      <div class="section-header">
        <h3>Recent Invoices</h3>
        <button class="btn btn-outline btn-sm" onclick="showPage('invoices')">View All</button>
      </div>
      <div class="table-wrap" id="dashboard-recent-table">
        <table>
          <thead><tr>
            <th>Date</th><th>Invoice #</th><th>Patient</th><th>Owner</th><th>Total</th><th>Status</th>
          </tr></thead>
          <tbody id="dashboard-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- RECEPTION -->
    <div class="page" id="page-reception">
      <div class="section-header">
        <h3>Patient Records</h3>
        <button class="btn btn-primary" onclick="openNewPatientModal()">+ New Patient</button>
      </div>

      <div class="filter-bar">
        <input type="text" class="search-input" placeholder="Search by pet name, owner, breed‚Ä¶" oninput="filterPatients(this.value)">
        <select onchange="filterPatients(null, this.value)">
          <option value="">All Types</option>
          <option value="Canine">Canine</option>
          <option value="Feline">Feline</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Pet Name</th><th>Type</th><th>Sex</th><th>Breed</th><th>Colour</th><th>Age</th><th>Owner</th><th>Phone</th><th>Actions</th>
          </tr></thead>
          <tbody id="patients-tbody"></tbody>
        </table>
        <div id="patients-empty" class="empty-state" style="display:none;">
          <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
          <h3>No patients yet</h3>
          <p>Register your first patient using the button above.</p>
        </div>
      </div>
    </div>

    <!-- CHECK-IN / SOAP -->
    <div class="page" id="page-checkin">
      <div class="section-header">
        <h3>Check-in / SOAP Notes</h3>
        <button class="btn btn-primary" onclick="openCheckinModal()">+ New Check-in</button>
      </div>

      <div class="filter-bar">
        <input type="text" class="search-input" placeholder="Search by patient or doctor‚Ä¶" oninput="filterCheckins(this.value)">
        <select onchange="filterCheckins(null, this.value)">
          <option value="">All</option>
          <option value="open">Open</option>
          <option value="done">Completed</option>
        </select>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Date</th><th>Patient</th><th>Owner</th><th>Doctor</th><th>Diagnosis</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="checkin-tbody"></tbody>
        </table>
        <div id="checkin-empty" class="empty-state" style="display:none;">
          <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
          <h3>No check-ins yet</h3>
          <p>Start a new check-in for a patient above.</p>
        </div>
      </div>
    </div>

    <!-- BILLING -->
    <div class="page" id="page-billing">
      <div class="section-header">
        <h3>Billing</h3>
        <button class="btn btn-primary" onclick="openBillingModal()">+ New Invoice</button>
      </div>

      <div class="filter-bar">
        <input type="text" class="search-input" placeholder="Search invoices‚Ä¶" oninput="filterBilling(this.value)">
        <select id="billing-status-filter" onchange="filterBilling(null, this.value)">
          <option value="">All Status</option>
          <option value="Paid">Paid</option>
          <option value="Draft">Draft</option>
          <option value="Outstanding">Outstanding</option>
        </select>
        <select id="billing-method-filter" onchange="filterBilling(null, null, this.value)">
          <option value="">All Methods</option>
          <option value="Cash">Cash</option>
          <option value="UPI">UPI</option>
          <option value="Card">Card</option>
        </select>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr>
            <th onclick="sortBilling('date')">Date ‚Üï</th>
            <th>Invoice #</th><th>Patient</th><th>Owner</th>
            <th onclick="sortBilling('total')">Total ‚Üï</th>
            <th onclick="sortBilling('balance')">Balance ‚Üï</th>
            <th>Method</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="billing-tbody"></tbody>
        </table>
        <div id="billing-empty" class="empty-state" style="display:none;">
          <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
          <h3>No invoices yet</h3>
          <p>Create your first invoice above.</p>
        </div>
        <div class="pagination" id="billing-pagination"></div>
      </div>
    </div>

    <!-- INVOICE HISTORY -->
    <div class="page" id="page-invoices">
      <div class="export-bar">
        <div>
          <h3>Revenue Reports & Export</h3>
          <p>Sort and download invoices by date range, week, month or year</p>
        </div>
        <div class="export-controls">
          <select id="export-period">
            <option value="all">All Time</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>
          <select id="export-month" style="display:none;">
            <option value="0">January</option><option value="1">February</option>
            <option value="2">March</option><option value="3">April</option>
            <option value="4">May</option><option value="5">June</option>
            <option value="6">July</option><option value="7">August</option>
            <option value="8">September</option><option value="9">October</option>
            <option value="10">November</option><option value="11">December</option>
          </select>
          <select id="export-year" style="display:none;">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <input type="date" id="export-from" style="display:none; background:rgba(255,255,255,0.15); border-color:rgba(255,255,255,0.3); color:white;">
          <input type="date" id="export-to" style="display:none; background:rgba(255,255,255,0.15); border-color:rgba(255,255,255,0.3); color:white;">
          <button class="btn btn-gold" onclick="exportExcel()">‚¨á Download Excel</button>
        </div>
      </div>

      <div class="filter-bar">
        <input type="text" class="search-input" placeholder="Search invoices, patients, owners‚Ä¶" oninput="filterInvoices(this.value)">
        <select onchange="filterInvoices(null, this.value)">
          <option value="">All Status</option>
          <option value="Paid">Paid</option>
          <option value="Draft">Draft</option>
          <option value="Outstanding">Outstanding</option>
        </select>
        <select id="inv-sort" onchange="sortInvoices(this.value)">
          <option value="date-desc">Newest First</option>
          <option value="date-asc">Oldest First</option>
          <option value="total-desc">Highest Total</option>
          <option value="total-asc">Lowest Total</option>
        </select>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Date</th><th>Invoice #</th><th>Patient</th><th>Type</th><th>Owner</th><th>Total</th><th>Balance</th><th>Method</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="invoices-tbody"></tbody>
        </table>
        <div id="invoices-empty" class="empty-state" style="display:none;">
          <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
          <h3>No invoices found</h3>
          <p>Adjust your filters or create new invoices in the Billing section.</p>
        </div>
        <div class="pagination" id="invoices-pagination"></div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ========== MODALS ========== -->

<!-- NEW PATIENT MODAL -->
<div class="modal-overlay" id="modal-patient">
  <div class="modal">
    <div class="modal-header">
      <h3>Register Patient</h3>
      <button class="modal-close" onclick="closeModal('modal-patient')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-section">
        <div class="form-section-title">üêæ Pet Details</div>
        <div class="form-grid cols3">
          <div class="form-group">
            <label>Pet Name *</label>
            <input type="text" id="p-name" placeholder="e.g. Aadhi">
          </div>
          <div class="form-group">
            <label>Type *</label>
            <select id="p-type">
              <option value="">Select</option>
              <option value="Canine">Canine (Dog)</option>
              <option value="Feline">Feline (Cat)</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Breed</label>
            <input type="text" id="p-breed" placeholder="e.g. Labrador">
          </div>
          <div class="form-group">
            <label>Colour</label>
            <input type="text" id="p-colour" placeholder="e.g. Golden">
          </div>
          <div class="form-group">
            <label>Age</label>
            <input type="text" id="p-age" placeholder="e.g. 6M 22D">
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select id="p-gender">
              <option value="">Select</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label>Patient ID</label>
            <input type="text" id="p-pid" placeholder="Auto-generated">
          </div>
          <div class="form-group">
            <label>Weight (kg)</label>
            <input type="number" id="p-weight" placeholder="0.0" step="0.1">
          </div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">üë§ Owner / Parent Details</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Owner Name *</label>
            <input type="text" id="p-owner" placeholder="e.g. Animal Care Trust">
          </div>
          <div class="form-group">
            <label>Phone Number *</label>
            <input type="tel" id="p-phone" placeholder="e.g. 9876543210">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="text" id="p-email" placeholder="e.g. owner@email.com">
          </div>
          <div class="form-group">
            <label>Address</label>
            <input type="text" id="p-address" placeholder="City / Area">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-patient')">Cancel</button>
      <button class="btn btn-primary" onclick="savePatient()">Register Patient</button>
    </div>
  </div>
</div>

<!-- CHECK-IN / SOAP MODAL -->
<div class="modal-overlay" id="modal-checkin">
  <div class="modal">
    <div class="modal-header">
      <h3>Check-in & SOAP Notes</h3>
      <button class="modal-close" onclick="closeModal('modal-checkin')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-section">
        <div class="form-section-title">Patient & Doctor</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Select Patient *</label>
            <select id="ci-patient"></select>
          </div>
          <div class="form-group">
            <label>Doctor Name *</label>
            <input type="text" id="ci-doctor" placeholder="e.g. Dr. Kripa">
          </div>
          <div class="form-group">
            <label>Visit Date</label>
            <input type="date" id="ci-date">
          </div>
          <div class="form-group">
            <label>Chief Complaint</label>
            <input type="text" id="ci-complaint" placeholder="Primary reason for visit">
          </div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">üìã SOAP ‚Äî Diagnosis Notes</div>
        <div class="soap-section">
          <div class="soap-block">
            <label>S ‚Äî Subjective</label>
            <textarea id="ci-subjective" placeholder="Patient history, owner observations, symptoms reported‚Ä¶"></textarea>
          </div>
          <div class="soap-block">
            <label>O ‚Äî Objective</label>
            <textarea id="ci-objective" placeholder="Physical exam findings, vitals, test results‚Ä¶"></textarea>
          </div>
          <div class="soap-block">
            <label>A ‚Äî Assessment</label>
            <textarea id="ci-assessment" placeholder="Diagnosis, differential diagnosis‚Ä¶"></textarea>
          </div>
          <div class="soap-block">
            <label>P ‚Äî Plan</label>
            <textarea id="ci-plan" placeholder="Treatment plan, medications, follow-up‚Ä¶"></textarea>
          </div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">üíä Treatment Notes</div>
        <div class="form-grid cols1">
          <div class="form-group">
            <label>Procedures Performed</label>
            <textarea id="ci-procedures" placeholder="e.g. Gas Anesthesia, Intestinal Resection‚Ä¶"></textarea>
          </div>
          <div class="form-group">
            <label>Medications Prescribed</label>
            <textarea id="ci-meds" placeholder="Drug name, dosage, frequency‚Ä¶"></textarea>
          </div>
          <div class="form-group">
            <label>Follow-up Instructions</label>
            <textarea id="ci-followup" placeholder="e.g. Return in 7 days, GI diet for 12 days‚Ä¶" style="min-height:60px;"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-checkin')">Cancel</button>
      <button class="btn btn-primary" onclick="saveCheckin()">Save Check-in</button>
    </div>
  </div>
</div>

<!-- BILLING MODAL -->
<div class="modal-overlay" id="modal-billing">
  <div class="modal" style="max-width:860px;">
    <div class="modal-header">
      <h3>Create Invoice</h3>
      <button class="modal-close" onclick="closeModal('modal-billing')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-section">
        <div class="form-section-title">Invoice Details</div>
        <div class="form-grid cols3">
          <div class="form-group">
            <label>Select Patient *</label>
            <select id="b-patient" onchange="autofillOwner()"></select>
          </div>
          <div class="form-group">
            <label>Owner</label>
            <input type="text" id="b-owner" readonly style="background:#f5f5f5;">
          </div>
          <div class="form-group">
            <label>Invoice Date</label>
            <input type="date" id="b-date">
          </div>
          <div class="form-group">
            <label>Invoice #</label>
            <input type="text" id="b-ref" readonly style="background:#f5f5f5;">
          </div>
          <div class="form-group">
            <label>Payment Method</label>
            <select id="b-method">
              <option value="">Select</option>
              <option value="Cash">Cash</option>
              <option value="UPI">UPI</option>
              <option value="Card">Card</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="b-status">
              <option value="Draft">Draft (Not Paid)</option>
              <option value="Paid">Paid</option>
              <option value="Outstanding">Outstanding</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">Line Items</div>
        <table class="billing-table" id="billing-items-table">
          <thead><tr>
            <th>Item / Service</th><th>Qty</th><th>Unit Price (‚Çπ)</th><th>Discount (‚Çπ)</th><th>Total (‚Çπ)</th><th></th>
          </tr></thead>
          <tbody id="billing-items-body"></tbody>
        </table>
        <button class="btn btn-outline btn-sm" onclick="addBillingRow()">+ Add Line Item</button>
        <div class="billing-total">
          <div class="total-line"><span>Sub Total</span><span id="b-subtotal">‚Çπ 0.00</span></div>
          <div class="total-line"><span>Discount</span><span id="b-discount-total">‚Çπ 0.00</span></div>
          <div class="total-line grand"><span>Total Due</span><span id="b-total">‚Çπ 0.00</span></div>
          <div class="total-line"><span>Amount Paid</span><input type="number" id="b-paid-amt" style="width:120px; text-align:right;" placeholder="0" oninput="calcBalance()"></div>
          <div class="total-line"><span>Balance</span><span id="b-balance">‚Çπ 0.00</span></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-billing')">Cancel</button>
      <button class="btn btn-primary" onclick="saveInvoice()">Save Invoice</button>
    </div>
  </div>
</div>

<!-- INVOICE VIEW MODAL -->
<div class="modal-overlay" id="modal-invoice-view">
  <div class="modal" style="max-width:680px;">
    <div class="modal-header">
      <h3>Invoice Preview</h3>
      <button class="modal-close" onclick="closeModal('modal-invoice-view')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="invoice-preview" id="invoice-preview-content"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-invoice-view')">Close</button>
      <button class="btn btn-gold" onclick="printInvoice()">üñ® Print / Save PDF</button>
    </div>
  </div>
</div>

<!-- CHECKIN VIEW MODAL -->
<div class="modal-overlay" id="modal-checkin-view">
  <div class="modal">
    <div class="modal-header">
      <h3>SOAP Notes ‚Äî <span id="checkin-view-patient"></span></h3>
      <button class="modal-close" onclick="closeModal('modal-checkin-view')">√ó</button>
    </div>
    <div class="modal-body" id="checkin-view-body"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-checkin-view')">Close</button>
      <button class="btn btn-primary" onclick="createInvoiceFromCheckin()">Create Invoice</button>
    </div>
  </div>
</div>


<!-- PATIENT PROFILE MODAL -->
<div class="modal-overlay" id="modal-profile">
  <div class="modal" style="max-width:860px;">
    <div class="modal-header">
      <h3>Patient Profile ‚Äî <span id="profile-modal-name"></span></h3>
      <button class="modal-close" onclick="closeModal('modal-profile')">√ó</button>
    </div>
    <div class="modal-body" id="profile-modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('modal-profile')">Close</button>
    </div>
  </div>
</div>

<div class="notification" id="notification"></div>

<script>

<script>
// ===================== API LAYER =====================
const API = 'http://localhost:3000/api';

async function api(method, path, body) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API + path, opts);
  const json = await res.json();
  if (!json.success) throw new Error(json.error || 'API error');
  return json.data;
}

const GET  = (p, q) => api('GET',    p + (q ? '?' + new URLSearchParams(q).toString() : ''));
const POST = (p, b) => api('POST',   p, b);
const PUT  = (p, b) => api('PUT',    p, b);
const PATCH= (p, b) => api('PATCH',  p, b);
const DEL  = (p)    => api('DELETE', p);

// ===================== STATE =====================
let patients = [];
let checkins = [];
let invoices = [];
let currentCheckinId = null;

function notify(msg, duration=3200) {
  const el = document.getElementById('notification');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), duration);
}

function fmt(n) {
  return '‚Çπ ' + Number(n||0).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function loading(show) {
  document.body.style.cursor = show ? 'wait' : 'default';
}

// ===================== NAVIGATION =====================
const pageTitles = {
  dashboard: 'Dashboard',
  reception: 'Reception ‚Äî Patient Records',
  checkin: 'Check-in & SOAP Notes',
  billing: 'Billing',
  invoices: 'Invoice History & Reports'
};

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  document.querySelectorAll('.nav-item')[['dashboard','reception','checkin','billing','invoices'].indexOf(id)].classList.add('active');
  document.getElementById('pageTitle').textContent = pageTitles[id];
  refreshPage(id);
}

function refreshPage(id) {
  if(id === 'dashboard') loadDashboard();
  if(id === 'reception') loadPatients();
  if(id === 'checkin')   loadCheckins();
  if(id === 'billing')   loadBilling();
  if(id === 'invoices')  loadInvoices();
}

// ===================== MODAL UTILS =====================
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ===================== DASHBOARD =====================
async function loadDashboard() {
  try {
    const stats = await GET('/stats');
    document.getElementById('stat-total').textContent   = (stats.total || 0).toLocaleString();
    document.getElementById('stat-revenue').textContent = 'Gross: ' + fmt(stats.gross_revenue);
    document.getElementById('stat-paid').textContent    = (stats.paid_count || 0).toLocaleString();
    document.getElementById('stat-paid-amt').textContent = fmt(stats.paid_amount);
    document.getElementById('stat-draft').textContent   = (stats.draft_count || 0).toLocaleString();
    document.getElementById('stat-draft-amt').textContent = fmt(stats.draft_balance);
    document.getElementById('stat-outstanding').textContent  = (stats.outstanding_count || 0).toLocaleString();
    document.getElementById('stat-outstanding-amt').textContent = fmt(stats.outstanding_balance);
    document.getElementById('stat-patients').textContent = (stats.patient_count || 0).toLocaleString();
    document.getElementById('stat-owners').textContent   = (stats.owner_count || 0).toLocaleString();
    document.getElementById('stat-checkins').textContent = (stats.open_checkins || 0).toLocaleString();
    document.getElementById('stat-vaccinations').textContent = (stats.vaccination_count || 0).toLocaleString();

    const recent = await GET('/invoices');
    const tbody = document.getElementById('dashboard-tbody');
    tbody.innerHTML = recent.slice(0,10).map(inv => `
      <tr>
        <td>${formatDate(inv.date)}</td>
        <td><code style="font-size:11px;">${inv.ref}</code></td>
        <td>${inv.patient_name}</td>
        <td>${inv.owner_name || '‚Äî'}</td>
        <td><strong>${fmt(inv.total)}</strong></td>
        <td>${statusBadge(inv.status)}</td>
      </tr>
    `).join('') || '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--mid-gray);">No invoices yet</td></tr>';
  } catch(e) { notify('‚ö† Could not load dashboard: ' + e.message); }
}

function formatDate(d) {
  if(!d) return '';
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
}

function statusBadge(s) {
  const m = {Paid:'badge-paid',Draft:'badge-draft',Outstanding:'badge-outstanding'};
  return `<span class="badge ${m[s]||'badge-draft'}">${s}</span>`;
}

// ===================== PATIENTS =====================
let patFilter = {text:'', type:''};

async function loadPatients() {
  try {
    loading(true);
    const q = {};
    if(patFilter.text) q.q = patFilter.text;
    if(patFilter.type) q.type = patFilter.type;
    patients = await GET('/patients', q);
    renderPatients();
  } catch(e) { notify('‚ö† ' + e.message); }
  finally { loading(false); }
}

function renderPatients() {
  const tbody = document.getElementById('patients-tbody');
  const empty = document.getElementById('patients-empty');
  if(!patients.length) { tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  tbody.innerHTML = patients.map(p => {
    const typeCls = (p.type||'other').toLowerCase().replace(/[^a-z]/g,'_');
    return `
    <tr>
      <td>
        <strong>${p.name}</strong>
        <br><small style="color:var(--mid-gray);font-size:11px;">${p.id || ('PaCPC-'+(p.patient_id||'')).padStart(5,'0')}</small>
      </td>
      <td><span class="type-badge type-${p.type==='Canine'?'canine':p.type==='Feline'?'feline':'other'}">${p.type||'‚Äî'}</span></td>
      <td>${p.sex||'‚Äî'}</td>
      <td>${p.breed||'‚Äî'}</td>
      <td>${p.colour||'‚Äî'}</td>
      <td>${p.age||'‚Äî'}</td>
      <td>${p.owner_name||'‚Äî'}</td>
      <td>${p.phone||'‚Äî'}</td>
      <td>
        <span class="action-link" onclick="viewPatientProfile('${p.id||'PaCPC-'+(p.patient_id||'')}')" title="Full profile">Profile</span>
        <span class="action-link" onclick="newInvoiceForPatient('${p.id||'PaCPC-'+(p.patient_id||'')}')" title="Create invoice">Invoice</span>
        <span class="action-link danger" onclick="deletePatient('${p.id||'PaCPC-'+(p.patient_id||'')}','${p.name.replace(/'/g,"\\'")}')" title="Delete">Del</span>
      </td>
    </tr>`;
  }).join('');
}

async function viewPatientProfile(id) {
  try {
    notify('Loading profile‚Ä¶');
    const profile = await GET('/patients/' + encodeURIComponent(id) + '/profile');
    const p = profile.patient;
    const vacc = profile.vaccinations || [];
    const soap = profile.soap_history || [];
    const invs = profile.invoices || [];

    const modalBody = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
        <div>
          <div class="form-section-title">üêæ Pet Details</div>
          <table style="font-size:13px;width:100%;border-collapse:collapse;">
            <tr><td style="color:var(--mid-gray);padding:3px 0;width:110px;">Name</td><td><strong>${p.name}</strong></td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">ID</td><td><code>${p.id||'‚Äî'}</code></td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">Species</td><td>${p.type||'‚Äî'}</td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">Sex</td><td>${p.sex||'‚Äî'}</td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">Breed</td><td>${p.breed||'‚Äî'}</td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">Colour</td><td>${p.colour||'‚Äî'}</td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">DOB/Age</td><td>${p.age||'‚Äî'}</td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">Microchip</td><td>${p.microchip_no||'‚Äî'}</td></tr>
          </table>
        </div>
        <div>
          <div class="form-section-title">üë§ Owner Details</div>
          <table style="font-size:13px;width:100%;border-collapse:collapse;">
            <tr><td style="color:var(--mid-gray);padding:3px 0;width:80px;">Name</td><td><strong>${p.owner_name||'‚Äî'}</strong></td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">Phone</td><td>${p.phone||'‚Äî'}</td></tr>
            <tr><td style="color:var(--mid-gray);padding:3px 0;">Email</td><td>${p.email||'‚Äî'}</td></tr>
          </table>
          ${vacc.length ? `
          <div class="form-section-title" style="margin-top:16px;">üíâ Vaccinations</div>
          <div style="font-size:12px;">
            ${vacc.slice(0,5).map(v=>'<div style="padding:3px 0;border-bottom:1px solid var(--light-gray);">'+
              '<strong>'+v.treatment+'</strong> <span style="color:var(--mid-gray);">'+v.type_care+'</span>'+
              (v.date ? ' ¬∑ '+v.date : '')+'</div>').join('')}
            ${vacc.length>5?'<small style="color:var(--mid-gray);">+'+(vacc.length-5)+' more‚Ä¶</small>':''}
          </div>` : ''}
        </div>
      </div>
      ${soap.length ? `
      <div class="form-section-title">üìã Visit History (last ${Math.min(soap.length,5)})</div>
      <div style="margin-bottom:16px;">
        ${soap.slice(0,5).map(s => '<div style="background:white;border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-bottom:8px;font-size:12px;">'+
          '<div style="display:flex;justify-content:space-between;margin-bottom:4px;">'+
          '<strong>'+(s.chief_complaint||'Visit')+'</strong>'+
          '<span style="color:var(--mid-gray);">'+(s.created_at||'').slice(0,10)+'</span></div>'+
          (s.diagnosis ? '<div>Dx: <em>'+s.diagnosis+'</em></div>' : '')+
          (s.weight ? '<span style="color:var(--mid-gray);">Weight: '+s.weight+'</span>' : '')+
          '</div>').join('')}
      </div>` : ''}
      ${invs.length ? `
      <div class="form-section-title">üßæ Recent Invoices</div>
      <table style="width:100%;font-size:12px;border-collapse:collapse;">
        <thead><tr style="background:var(--forest);color:white;">
          <th style="padding:6px 10px;text-align:left;">Ref</th>
          <th style="padding:6px 10px;">Date</th>
          <th style="padding:6px 10px;text-align:right;">Total</th>
          <th style="padding:6px 10px;">Status</th>
          <th style="padding:6px 10px;">Method</th>
        </tr></thead>
        <tbody>
          ${invs.slice(0,8).map(i=>'<tr style="border-bottom:1px solid var(--light-gray);">'+
            '<td style="padding:6px 10px;font-family:monospace;font-size:11px;">'+i.ref+'</td>'+
            '<td style="padding:6px 10px;text-align:center;">'+formatDate(i.date)+'</td>'+
            '<td style="padding:6px 10px;text-align:right;font-weight:600;">'+fmt(i.total)+'</td>'+
            '<td style="padding:6px 10px;">'+statusBadge(i.status)+'</td>'+
            '<td style="padding:6px 10px;">'+((i.method||i.payment_type)||'‚Äî')+'</td>'+
            '</tr>').join('')}
        </tbody>
      </table>` : ''}
    `;
    document.getElementById('profile-modal-name').textContent = p.name + (p.type ? ' ¬∑ ' + p.type : '');
    document.getElementById('profile-modal-body').innerHTML = modalBody;
    openModal('modal-profile');
  } catch(e) { notify('‚ö† ' + e.message); }
}

function filterPatients(txt, type) {
  if(txt !== null && txt !== undefined) patFilter.text = txt;
  if(type !== undefined) patFilter.type = type;
  loadPatients();
}

function openNewPatientModal() {
  ['p-name','p-breed','p-colour','p-age','p-owner','p-phone','p-email','p-address'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('p-type').value = '';
  document.getElementById('p-gender').value = '';
  document.getElementById('p-weight').value = '';
  document.getElementById('p-pid').value = '(auto-generated)';
  openModal('modal-patient');
}

async function savePatient() {
  const name = document.getElementById('p-name').value.trim();
  const owner_name = document.getElementById('p-owner').value.trim();
  if(!name) { notify('‚ö† Pet name is required'); return; }
  if(!owner_name) { notify('‚ö† Owner name is required'); return; }

  try {
    loading(true);
    await POST('/patients', {
      name, owner_name,
      type:    document.getElementById('p-type').value,
      breed:   document.getElementById('p-breed').value,
      colour:  document.getElementById('p-colour').value,
      age:     document.getElementById('p-age').value,
      gender:  document.getElementById('p-gender').value,
      weight:  document.getElementById('p-weight').value,
      phone:   document.getElementById('p-phone').value,
      email:   document.getElementById('p-email').value,
      address: document.getElementById('p-address').value,
    });
    closeModal('modal-patient');
    notify('‚úì Patient ' + name + ' registered');
    loadPatients();
  } catch(e) { notify('‚ö† ' + e.message); }
  finally { loading(false); }
}

async function deletePatient(id, name) {
  if(!confirm(`Delete patient "${name}"? Their invoices will remain.`)) return;
  try {
    await DEL('/patients/' + id);
    notify('Patient deleted');
    loadPatients();
  } catch(e) { notify('‚ö† ' + e.message); }
}

function newInvoiceForPatient(id) {
  showPage('billing');
  setTimeout(() => openBillingModal(id), 100);
}

// ===================== CHECKINS =====================
let ciFilter = {text:'', status:''};

async function loadCheckins() {
  try {
    loading(true);
    const q = {};
    if(ciFilter.text)   q.q = ciFilter.text;
    if(ciFilter.status) q.status = ciFilter.status;
    checkins = await GET('/checkins', q);
    renderCheckins();
  } catch(e) { notify('‚ö† ' + e.message); }
  finally { loading(false); }
}

function renderCheckins() {
  const tbody = document.getElementById('checkin-tbody');
  const empty = document.getElementById('checkin-empty');
  if(!checkins.length) { tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  tbody.innerHTML = checkins.map(c => `
    <tr>
      <td>${formatDate(c.date)}</td>
      <td><strong>${c.patient_name}</strong></td>
      <td>${c.owner_name||'‚Äî'}</td>
      <td>${c.doctor}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${c.assessment||'‚Äî'}</td>
      <td><span class="badge ${c.status==='done'?'badge-paid':'badge-draft'}">${c.status==='done'?'Completed':'Open'}</span></td>
      <td>
        <span class="action-link" onclick="viewCheckin('${c.id}')">View</span>
        <span class="action-link" onclick="markCheckinDone('${c.id}')">Complete</span>
        <span class="action-link danger" onclick="deleteCheckin('${c.id}')">Delete</span>
      </td>
    </tr>
  `).join('');
}

function filterCheckins(txt, status) {
  if(txt !== null && txt !== undefined) ciFilter.text = txt;
  if(status !== undefined) ciFilter.status = status;
  loadCheckins();
}

async function openCheckinModal() {
  try {
    patients = await GET('/patients');
  } catch(e) {}
  const sel = document.getElementById('ci-patient');
  sel.innerHTML = '<option value="">‚Äî Select Patient ‚Äî</option>' +
    patients.map(p => `<option value="${p.id}">${p.name} (${p.owner_name})</option>`).join('');
  document.getElementById('ci-date').value = new Date().toISOString().slice(0,10);
  ['ci-doctor','ci-complaint','ci-subjective','ci-objective','ci-assessment','ci-plan','ci-procedures','ci-meds','ci-followup'].forEach(id=>document.getElementById(id).value='');
  openModal('modal-checkin');
}

async function saveCheckin() {
  const patient_id = document.getElementById('ci-patient').value;
  const doctor = document.getElementById('ci-doctor').value.trim();
  const date = document.getElementById('ci-date').value;
  if(!doctor) { notify('‚ö† Doctor name required'); return; }
  if(!date)   { notify('‚ö† Date required'); return; }

  try {
    loading(true);
    await POST('/checkins', {
      patient_id, doctor, date,
      complaint:   document.getElementById('ci-complaint').value,
      subjective:  document.getElementById('ci-subjective').value,
      objective:   document.getElementById('ci-objective').value,
      assessment:  document.getElementById('ci-assessment').value,
      plan:        document.getElementById('ci-plan').value,
      procedures:  document.getElementById('ci-procedures').value,
      medications: document.getElementById('ci-meds').value,
      followup:    document.getElementById('ci-followup').value,
    });
    closeModal('modal-checkin');
    notify('‚úì Check-in saved');
    loadCheckins();
  } catch(e) { notify('‚ö† ' + e.message); }
  finally { loading(false); }
}

async function viewCheckin(id) {
  currentCheckinId = id;
  const c = checkins.find(x=>x.id===id);
  if(!c) return;
  document.getElementById('checkin-view-patient').textContent = c.patient_name;
  document.getElementById('checkin-view-body').innerHTML = `
    <div style="margin-bottom:16px;">
      <div class="form-section-title" style="margin-bottom:10px;">Visit Info</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;">
        <div><strong>Date:</strong> ${formatDate(c.date)}</div>
        <div><strong>Doctor:</strong> ${c.doctor}</div>
        <div><strong>Patient:</strong> ${c.patient_name}</div>
        <div><strong>Owner:</strong> ${c.owner_name||'‚Äî'}</div>
        <div style="grid-column:span 2;"><strong>Chief Complaint:</strong> ${c.complaint||'‚Äî'}</div>
      </div>
    </div>
    <div class="form-section-title" style="margin-bottom:10px;">SOAP Notes</div>
    <div class="soap-section" style="margin-bottom:16px;">
      <div class="soap-block"><label>S ‚Äî Subjective</label><p style="font-size:13px;white-space:pre-wrap;">${c.subjective||'‚Äî'}</p></div>
      <div class="soap-block"><label>O ‚Äî Objective</label><p style="font-size:13px;white-space:pre-wrap;">${c.objective||'‚Äî'}</p></div>
      <div class="soap-block"><label>A ‚Äî Assessment</label><p style="font-size:13px;white-space:pre-wrap;">${c.assessment||'‚Äî'}</p></div>
      <div class="soap-block"><label>P ‚Äî Plan</label><p style="font-size:13px;white-space:pre-wrap;">${c.plan||'‚Äî'}</p></div>
    </div>
    <div class="form-section-title" style="margin-bottom:10px;">Treatment</div>
    <div style="font-size:13px;">
      <p><strong>Procedures:</strong> ${c.procedures||'‚Äî'}</p>
      <p style="margin-top:8px;"><strong>Medications:</strong> ${c.medications||'‚Äî'}</p>
      <p style="margin-top:8px;"><strong>Follow-up:</strong> ${c.followup||'‚Äî'}</p>
    </div>
  `;
  openModal('modal-checkin-view');
}

async function markCheckinDone(id) {
  try {
    await PATCH('/checkins/' + id + '/status', { status: 'done' });
    notify('Marked as completed');
    loadCheckins();
  } catch(e) { notify('‚ö† ' + e.message); }
}

async function deleteCheckin(id) {
  if(!confirm('Delete this check-in record?')) return;
  try {
    await DEL('/checkins/' + id);
    notify('Deleted');
    loadCheckins();
  } catch(e) { notify('‚ö† ' + e.message); }
}

async function createInvoiceFromCheckin() {
  const c = checkins.find(x=>x.id===currentCheckinId);
  closeModal('modal-checkin-view');
  showPage('billing');
  setTimeout(async () => {
    await openBillingModal(c ? c.patient_id : null);
    if(c && c.procedures) {
      document.getElementById('billing-items-body').innerHTML = '';
      c.procedures.split('\n').filter(l=>l.trim()).forEach(line => addBillingRow(line.trim()));
    }
  }, 150);
}

// ===================== BILLING =====================
let billingFilter = {text:'', status:'', method:''};
let billingSortField = 'date', billingSortDir = 'desc';

async function loadBilling() {
  try {
    loading(true);
    const q = {};
    if(billingFilter.text) q.q = billingFilter.text;
    if(billingFilter.status) q.status = billingFilter.status;
    invoices = await GET('/invoices', q);
    renderBilling();
  } catch(e) { notify('‚ö† ' + e.message); }
  finally { loading(false); }
}

function renderBilling() {
  let data = [...invoices];
  if(billingFilter.method) data = data.filter(i=>i.method===billingFilter.method);
  data = sortInvoiceData(data, billingSortField, billingSortDir);

  const tbody = document.getElementById('billing-tbody');
  const empty = document.getElementById('billing-empty');
  if(!data.length) { tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';

  tbody.innerHTML = data.map(inv => `
    <tr>
      <td>${formatDate(inv.date)}</td>
      <td><code style="font-size:11px;">${inv.ref}</code></td>
      <td><strong>${inv.patient_name}</strong></td>
      <td>${inv.owner_name}</td>
      <td><strong>${fmt(inv.total)}</strong></td>
      <td style="color:${inv.balance>0?'var(--rust)':'var(--paid)'};">${fmt(inv.balance)}</td>
      <td>${inv.method?`<span class="pay-method">${inv.method}</span>`:'‚Äî'}</td>
      <td>${statusBadge(inv.status)}</td>
      <td>
        <span class="action-link" onclick="previewInvoice('${encodeURIComponent(inv.ref)}')">View</span>
        <span class="action-link" onclick="cycleStatus('${encodeURIComponent(inv.ref)}')">Status</span>
        <span class="action-link danger" onclick="deleteInvoice('${encodeURIComponent(inv.ref)}')">Del</span>
      </td>
    </tr>
  `).join('');
}

function filterBilling(txt, status, method) {
  if(txt !== null && txt !== undefined) billingFilter.text = txt;
  if(status !== undefined) billingFilter.status = status;
  if(method !== undefined) billingFilter.method = method;
  if(billingFilter.text || billingFilter.status) loadBilling(); else renderBilling();
}

function sortBilling(field) {
  if(billingSortField===field) billingSortDir = billingSortDir==='asc'?'desc':'asc';
  else { billingSortField=field; billingSortDir='desc'; }
  renderBilling();
}

function sortInvoiceData(data, field, dir) {
  return data.sort((a,b) => {
    let va = field==='date' ? new Date(a.date) : a[field]||0;
    let vb = field==='date' ? new Date(b.date) : b[field]||0;
    return dir==='asc' ? va-vb : vb-va;
  });
}

async function openBillingModal(prePatientId) {
  try {
    patients = await GET('/patients');
  } catch(e) {}
  const sel = document.getElementById('b-patient');
  sel.innerHTML = '<option value="">‚Äî Select Patient ‚Äî</option>' +
    patients.map(p => `<option value="${p.id}">${p.name} (${p.owner_name})</option>`).join('');
  if(prePatientId) { sel.value = prePatientId; autofillOwner(); }

  const now = new Date();
  document.getElementById('b-date').value = now.toISOString().slice(0,10);

  const yy = String(now.getFullYear()).slice(2);
  const mm = String(now.getMonth()+1).padStart(2,'0');
  document.getElementById('b-ref').value = `IN:01-${yy}${mm}-####`;

  document.getElementById('b-method').value = '';
  document.getElementById('b-status').value = 'Draft';
  document.getElementById('b-paid-amt').value = '';
  document.getElementById('billing-items-body').innerHTML = '';
  addBillingRow(); addBillingRow();
  calcTotals();
  openModal('modal-billing');
}

function autofillOwner() {
  const pid = document.getElementById('b-patient').value;
  const pat = patients.find(p=>p.id===pid);
  document.getElementById('b-owner').value = pat ? pat.owner_name : '';
}

function addBillingRow(name='') {
  const tbody = document.getElementById('billing-items-body');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" style="width:100%;" placeholder="Item / Service" value="${name}" oninput="calcTotals()"></td>
    <td><input type="number" value="1" min="1" oninput="calcTotals()" style="width:60px;"></td>
    <td><input type="number" value="0" min="0" oninput="calcTotals()" style="width:100px;"></td>
    <td><input type="number" value="0" min="0" oninput="calcTotals()" style="width:80px;"></td>
    <td class="row-total" style="font-weight:600;">‚Çπ 0.00</td>
    <td><button class="remove-row" onclick="this.closest('tr').remove();calcTotals()">√ó</button></td>
  `;
  tbody.appendChild(tr);
}

function calcTotals() {
  let subtotal=0, discTotal=0;
  document.querySelectorAll('#billing-items-body tr').forEach(row => {
    const inputs = row.querySelectorAll('input[type=number]');
    const qty   = parseFloat(inputs[0].value)||0;
    const price = parseFloat(inputs[1].value)||0;
    const disc  = parseFloat(inputs[2].value)||0;
    const lineTotal = qty*price - disc;
    subtotal  += qty*price;
    discTotal += disc;
    row.querySelector('.row-total').textContent = '‚Çπ ' + lineTotal.toFixed(2);
  });
  const total = subtotal - discTotal;
  document.getElementById('b-subtotal').textContent       = '‚Çπ ' + subtotal.toFixed(2);
  document.getElementById('b-discount-total').textContent = '‚Çπ ' + discTotal.toFixed(2);
  document.getElementById('b-total').textContent          = '‚Çπ ' + total.toFixed(2);
  calcBalance(total);
}

function calcBalance(total) {
  if(total === undefined) total = parseFloat(document.getElementById('b-total').textContent.replace(/[‚Çπ,\s]/g,''))||0;
  const paid = parseFloat(document.getElementById('b-paid-amt').value)||0;
  document.getElementById('b-balance').textContent = '‚Çπ ' + Math.max(0, total-paid).toFixed(2);
}

async function saveInvoice() {
  const patient_id = document.getElementById('b-patient').value;
  if(!patient_id) { notify('‚ö† Select a patient'); return; }

  const items = [];
  document.querySelectorAll('#billing-items-body tr').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const name = inputs[0].value.trim();
    if(name) items.push({
      name,
      quantity:   parseFloat(inputs[1].value)||1,
      unit_price: parseFloat(inputs[2].value)||0,
      discount:   parseFloat(inputs[3].value)||0,
    });
  });
  if(!items.length) { notify('‚ö† Add at least one item'); return; }

  const paid_amount = parseFloat(document.getElementById('b-paid-amt').value)||0;

  try {
    loading(true);
    const inv = await POST('/invoices', {
      patient_id,
      owner_name:   document.getElementById('b-owner').value,
      date:         document.getElementById('b-date').value,
      method:       document.getElementById('b-method').value,
      status:       document.getElementById('b-status').value,
      paid_amount, items
    });
    closeModal('modal-billing');
    notify('‚úì Invoice ' + inv.ref + ' saved to database');
    loadBilling();
    loadDashboard();
  } catch(e) { notify('‚ö† ' + e.message); }
  finally { loading(false); }
}

async function cycleStatus(ref) {
  ref = decodeURIComponent(ref);
  const inv = invoices.find(i=>i.ref===ref);
  if(!inv) return;
  const statuses = ['Paid','Draft','Outstanding'];
  const next = statuses[(statuses.indexOf(inv.status)+1)%3];
  if(!confirm(`Change status to ${next}?`)) return;
  try {
    await PATCH('/invoices/' + encodeURIComponent(ref) + '/status', { status: next });
    notify('Status ‚Üí ' + next);
    loadBilling();
    loadDashboard();
  } catch(e) { notify('‚ö† ' + e.message); }
}

async function deleteInvoice(ref) {
  ref = decodeURIComponent(ref);
  if(!confirm('Delete this invoice permanently?')) return;
  try {
    await DEL('/invoices/' + encodeURIComponent(ref));
    notify('Invoice deleted');
    loadBilling();
    loadInvoices();
    loadDashboard();
  } catch(e) { notify('‚ö† ' + e.message); }
}

// ===================== INVOICES PAGE =====================
let invFilter = {text:'', status:''};
let invSortMode = 'date-desc';
const INV_PER_PAGE = 20;
let invPage = 1;
let allInvoices = [];

async function loadInvoices() {
  try {
    loading(true);
    const q = { sort: invSortMode };
    if(invFilter.text) q.q = invFilter.text;
    if(invFilter.status) q.status = invFilter.status;

    const period = document.getElementById('export-period').value;
    const now = new Date();
    if(period === 'week') {
      const start = new Date(now); start.setDate(now.getDate()-now.getDay());
      q.from = start.toISOString().slice(0,10);
      q.to   = now.toISOString().slice(0,10);
    } else if(period === 'month') {
      q.from = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
      q.to   = now.toISOString().slice(0,10);
    } else if(period === 'year') {
      q.from = `${now.getFullYear()}-01-01`;
      q.to   = now.toISOString().slice(0,10);
    } else if(period === 'custom') {
      const from = document.getElementById('export-from').value;
      const to   = document.getElementById('export-to').value;
      if(from) q.from = from;
      if(to)   q.to   = to;
    }

    allInvoices = await GET('/invoices', q);
    invPage = 1;
    renderInvoices();
  } catch(e) { notify('‚ö† ' + e.message); }
  finally { loading(false); }
}

function renderInvoices() {
  const total = allInvoices.length;
  const pages = Math.ceil(total / INV_PER_PAGE);
  const slice = allInvoices.slice((invPage-1)*INV_PER_PAGE, invPage*INV_PER_PAGE);

  const tbody = document.getElementById('invoices-tbody');
  const empty = document.getElementById('invoices-empty');

  if(!slice.length) { tbody.innerHTML=''; empty.style.display='block'; }
  else {
    empty.style.display='none';
    tbody.innerHTML = slice.map(inv => `
      <tr>
        <td>${formatDate(inv.date)}</td>
        <td><code style="font-size:11px;">${inv.ref}</code></td>
        <td><strong>${inv.patient_name}</strong></td>
        <td>${inv.patient_type?`<span class="type-badge type-${(inv.patient_type||'other').toLowerCase()}">${inv.patient_type}</span>`:'‚Äî'}</td>
        <td>${inv.owner_name}</td>
        <td><strong>${fmt(inv.total)}</strong></td>
        <td style="color:${inv.balance>0?'var(--rust)':'var(--paid)'};">${fmt(inv.balance)}</td>
        <td>${inv.method?`<span class="pay-method">${inv.method}</span>`:'‚Äî'}</td>
        <td>${statusBadge(inv.status)}</td>
        <td>
          <span class="action-link" onclick="previewInvoice('${encodeURIComponent(inv.ref)}')">View</span>
          <span class="action-link danger" onclick="deleteInvoice('${encodeURIComponent(inv.ref)}')">Del</span>
        </td>
      </tr>
    `).join('');
  }

  const pg = document.getElementById('invoices-pagination');
  if(pages <= 1) { pg.innerHTML=''; return; }
  let btns = '';
  for(let i=1;i<=pages;i++) btns += `<button class="page-btn ${i===invPage?'active':''}" onclick="gotoInvPage(${i})">${i}</button>`;
  pg.innerHTML = `<span>Showing ${(invPage-1)*INV_PER_PAGE+1}‚Äì${Math.min(invPage*INV_PER_PAGE,total)} of ${total}</span>
    <div class="pagination-btns">${btns}</div>`;
}

function gotoInvPage(p) { invPage=p; renderInvoices(); }

function filterInvoices(txt, status) {
  if(txt !== null && txt !== undefined) invFilter.text = txt;
  if(status !== undefined) invFilter.status = status;
  loadInvoices();
}

function sortInvoices(val) { invSortMode = val; loadInvoices(); }

document.getElementById('export-period').addEventListener('change', function() {
  const v = this.value;
  document.getElementById('export-from').style.display = v==='custom' ? '' : 'none';
  document.getElementById('export-to').style.display   = v==='custom' ? '' : 'none';
  loadInvoices();
});
document.getElementById('export-from').addEventListener('change', () => loadInvoices());
document.getElementById('export-to').addEventListener('change', () => loadInvoices());

// ===================== INVOICE PREVIEW =====================
async function previewInvoice(ref) {
  ref = decodeURIComponent(ref);
  try {
    const inv = await GET('/invoices/' + encodeURIComponent(ref));
    const itemsHTML = (inv.items||[]).map(item => `
      <tr>
        <td style="padding:8px 10px;">${item.name}</td>
        <td style="padding:8px 10px;text-align:center;">${item.quantity}</td>
        <td style="padding:8px 10px;text-align:right;">‚Çπ ${Number(item.unit_price).toFixed(2)}</td>
        <td style="padding:8px 10px;text-align:right;">‚Çπ ${Number(item.discount||0).toFixed(2)}</td>
        <td style="padding:8px 10px;text-align:right;font-weight:600;">‚Çπ ${Number(item.total).toFixed(2)}</td>
      </tr>
    `).join('');

    document.getElementById('invoice-preview-content').innerHTML = `
      <div class="inv-header">
        <div class="inv-clinic">
          <h2>Paws and Claws Pet Clinic</h2>
          <p>164 Thomas Avenue, Chennai ‚Äì 600115</p>
        </div>
        <div style="text-align:right;">
          <div style="font-size:28px;font-weight:700;font-family:'Playfair Display',serif;color:var(--forest);">Invoice</div>
          <div style="font-size:13px;color:var(--mid-gray);margin-top:4px;">${inv.ref}</div>
        </div>
      </div>
      <div class="inv-details-grid" style="margin-bottom:20px;">
        <div>
          <div class="inv-section-label">Billed To ‚Äî Patient</div>
          <div class="inv-section-value">${inv.patient_name}${inv.patient_type?' | '+inv.patient_type:''}</div>
          <div class="inv-section-sub">Owner / Parent: <strong>${inv.owner_name}</strong></div>
          ${inv.phone?`<div class="inv-section-sub">Phone: ${inv.phone}</div>`:''}
        </div>
        <div style="text-align:right;">
          <div class="inv-section-label">Invoice Date</div>
          <div class="inv-section-value">${formatDate(inv.date)}</div>
          <div style="margin-top:12px;">
            <div class="inv-section-label">Total Due</div>
            <div style="font-size:24px;font-weight:700;color:var(--forest);">‚Çπ ${Number(inv.total).toLocaleString('en-IN',{minimumFractionDigits:2})}</div>
          </div>
        </div>
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:13px;margin-bottom:16px;">
        <thead><tr style="background:var(--forest);color:white;">
          <th style="padding:8px 10px;text-align:left;">Item Name</th>
          <th style="padding:8px 10px;text-align:center;">Qty</th>
          <th style="padding:8px 10px;text-align:right;">Price</th>
          <th style="padding:8px 10px;text-align:right;">Discount</th>
          <th style="padding:8px 10px;text-align:right;">Total</th>
        </tr></thead>
        <tbody style="border:1px solid var(--border);">${itemsHTML}</tbody>
      </table>
      <div style="text-align:right;font-size:13px;">
        <div style="display:flex;justify-content:flex-end;gap:40px;padding:4px 0;"><span style="color:var(--mid-gray);">Sub Total</span><strong>${fmt(inv.subtotal)}</strong></div>
        <div style="display:flex;justify-content:flex-end;gap:40px;padding:4px 0;"><span style="color:var(--mid-gray);">Discount</span><strong>${fmt(inv.discount)}</strong></div>
        <div style="display:flex;justify-content:flex-end;gap:40px;padding:8px 0;border-top:2px solid var(--forest);margin-top:4px;"><span style="font-size:15px;font-weight:600;">Total</span><strong style="font-size:15px;">${fmt(inv.total)}</strong></div>
        <div style="display:flex;justify-content:flex-end;gap:40px;padding:4px 0;"><span style="color:var(--mid-gray);">Amount Paid</span><strong>${fmt(inv.paid_amount)}</strong></div>
        <div style="display:flex;justify-content:flex-end;gap:40px;padding:4px 0;"><span style="color:var(--rust);">Balance Due</span><strong style="color:var(--rust);">${fmt(inv.balance)}</strong></div>
      </div>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:11px;text-align:center;color:var(--mid-gray);">
        Status: <strong>${inv.status}</strong>${inv.method?' ¬∑ Payment: '+inv.method:''} ¬∑ Paws & Claws Clinic ¬∑ 164 Thomas Avenue, Chennai ‚Äì 600115
      </div>
    `;
    openModal('modal-invoice-view');
  } catch(e) { notify('‚ö† Could not load invoice: ' + e.message); }
}

function printInvoice() {
  const content = document.getElementById('invoice-preview-content').innerHTML;
  const win = window.open('','_blank');
  win.document.write(`<html><head><title>Invoice</title><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans&display=swap" rel="stylesheet"><style>body{font-family:'DM Sans',sans-serif;padding:40px;max-width:700px;margin:0 auto;}@media print{body{padding:20px;}}</style></head><body>${content}</body></html>`);
  win.document.close();
  setTimeout(()=>win.print(),500);
}

// ===================== EXCEL EXPORT =====================
async function exportExcel() {
  try {
    notify('Preparing report‚Ä¶');
    const data = allInvoices.length ? allInvoices : await GET('/invoices');
    if(!data.length) { notify('‚ö† No data to export'); return; }

    const rows = data.map(inv => ({
      'DATE':           formatDate(inv.date),
      'REF':            inv.ref,
      'PATIENT':        inv.patient_name,
      'TYPE':           inv.patient_type||'',
      'CLIENT':         inv.owner_name,
      'PHONE':          inv.phone||'',
      'TOTAL':          inv.total,
      'AMOUNT_PAID':    inv.paid_amount||0,
      'BALANCE':        inv.balance,
      'PAYMENT_METHOD': inv.method||'',
      'STATUS':         inv.status
    }));

    const ws = XLSX.utils.json_to_sheet(rows);
    ws['!cols'] = [{wch:18},{wch:20},{wch:18},{wch:10},{wch:22},{wch:14},{wch:12},{wch:14},{wch:12},{wch:16},{wch:12}];

    const paid = data.filter(i=>i.status==='Paid');
    const draft = data.filter(i=>i.status==='Draft');
    const out = data.filter(i=>i.status==='Outstanding');

    XLSX.utils.sheet_add_aoa(ws, [
      [],
      ['‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ'],
      ['Total Invoices', data.length, '', 'Gross Revenue', data.reduce((a,b)=>a+b.total,0)],
      ['Paid', paid.length, '', 'Paid Amount', paid.reduce((a,b)=>a+b.total,0)],
      ['Draft', draft.length, '', 'Draft Balance', draft.reduce((a,b)=>a+b.balance,0)],
      ['Outstanding', out.length, '', 'Outstanding Balance', out.reduce((a,b)=>a+b.balance,0)],
    ], { origin: rows.length + 3 });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Revenue Report');
    const filename = `PawsClaws_Revenue_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, filename);
    notify('‚úì Excel downloaded: ' + filename);
  } catch(e) { notify('‚ö† Export failed: ' + e.message); }
}

// ===================== INIT =====================
document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

// Check server connection then load
(async () => {
  try {
    await loadDashboard();
  } catch(e) {
    notify('‚ö† Cannot connect to server. Make sure server.js is running on port 3000.');
    document.getElementById('stat-total').textContent = '‚Äî';
    document.getElementById('stat-paid').textContent = '‚Äî';
    document.getElementById('stat-draft').textContent = '‚Äî';
    document.getElementById('stat-outstanding').textContent = '‚Äî';

    // Show connection error banner
    const banner = document.createElement('div');
    banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#B85C38;color:white;text-align:center;padding:10px;font-size:13px;z-index:9999;font-family:DM Sans,sans-serif;';
    banner.innerHTML = '‚ö† Server not running. <strong>Run: npm install && node server.js</strong> in the project folder, then refresh.';
    document.body.prepend(banner);
  }
})();
</script>
</body>
</html>
